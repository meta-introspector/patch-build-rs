# TODO for patch-build-rs Repository

This document outlines the current state, vision, and immediate next steps for the `patch-build-rs` project, which serves as the foundational component for our self-healing, reflective Rust ecosystem.

## 1. Project Vision (The Technical Moonshine)

Our ultimate goal is a Grand Unified Theory of Computation, where:
*   **Everything is a macro**: From hardware bit patterns to OS functions, build systems, and application code.
*   **Errors are Continuations**: Compiler/Cargo errors are not failures but signals for a meta-level intervention.
*   **Resolution is a SAT Problem**: Errors are automatically resolved by a SAT solver that finds and applies optimal semantic rewrite rules (patches).
*   **Unified Process & Data**: The entire system operates cohesively within a single process space and manages a "massive matrix of data" (Layer 9 data fabric) for full context and analysis.
*   **Mathematical Predictability**: The system adheres to ITIL/ITSM/ISO9k quality specs, with runtime profiles approximating advanced mathematical functions (L-functions, modular forms).
*   **Ontological Hypotheses**: Each generated system is a "meme" â€“ a self-propagating unit of knowledge that represents a testable hypothesis about our computational ontology.

## 2. Current State & Achievements (Commit 6b805d6)

As of commit `6b805d6` (`feat: Implement mkbuildrs with extended args and initial mkslop auto-fix`), we have:

*   **`patch-build-rs-macros` crate**:
    *   **`mkbuildrs!` macro**: A procedural macro to declaratively generate `build.rs` content.
        *   Parses and generates `cargo:rustc-check-cfg` statements.
        *   Parses and generates `cargo:rustc-cfg` statements.
        *   **Extended arguments**: Added parsing and generation for:
            *   `resource_req`: RAM, CPU, instance type.
            *   `secret_req`: List of secret names.
            *   `systemd_service`: Service name, start command.
            *   `userdata_script`: Script path.
        *   These extended arguments generate `cargo:info` messages, intended to be rolled up into infrastructure (e.g., Terraform/Nix) arguments.
    *   **`mkslop!` macro**: A specialized macro designed to apply auto-fixes to AI-generated code, particularly problematic format string issues.
        *   It currently fixes the specific `cargo:rustc-cfg={0}="{1}"` format string (generated by `mkbuildrs!`) that caused `invalid format string` errors.
        *   `mkbuildrs!` is integrated to wrap `cfg` statements with `mkslop!`.

*   **`mkslop-core` library crate**: Contains the core logic (`fix_cfg_format_string`) for `mkslop!`.
*   **`mkslop-macros` proc-macro crate**: Implements the `mkslop!` macro, leveraging `mkslop-core`.
*   **Minimal Test Bed**: Established `mkslop_test_projects/cfg_warning_fix` to validate `mkbuildrs!` and `mkslop!` functionality in isolation.
    *   **STATUS**: `cargo check` on this project is currently *failing*, despite `mkslop-core` and `mkslop-macros` being designed to address the format string error. The immediate problem is debugging this test bed's failure.

## 3. Immediate Next Steps & TODOs

1.  **Debug `mkslop_test_projects/cfg_warning_fix` Compilation Failure**:
    *   Identify the exact error message from `stdout.jsonl` or `stderr.txt` after `cargo check`.
    *   Resolve the current error preventing the minimal test project from compiling successfully. This will validate the `mkslop!` integration and fix.

2.  **Verify `cargo:info` Output**:
    *   Once compilation is successful, inspect the `stdout.jsonl` for `cargo:info` messages to confirm that all `resource_req`, `secret_req`, `systemd_service`, and `userdata_script` arguments are correctly propagated.

3.  **Refactor `submodules/rust/compiler/rustc_llvm/build.rs`**:
    *   Apply the full `mkbuildrs!` macro invocation (including all `check_cfg` and `cfg` and new directive types) to the original `rustc_llvm/build.rs`.
    *   Verify that `cargo check -p rustc_llvm` compiles cleanly and emits the expected `cargo:info` messages.

4.  **Extend `mkslop!` Functionality**:
    *   Expand `mkslop!` to detect and fix other common "AI-generated code" issues, such as `{{}}` vs `{}` in format strings, or version upgrade inconsistencies.
    *   Develop a more generic `mkreplace!` mechanism as suggested, allowing for pattern-based rewriting.

5.  **Integrate with Layer 9 Data Fabric**:
    *   Develop mechanisms for `mkbuildrs!` to output structured data (e.g., JSON) representing resource requirements, secrets, etc., into the Layer 9 RDF/RocksDB/Solana data fabric. This will be the bridge to Terraform and other IaC tools.

6.  **Formalize Error Continuations**:
    *   Develop Rust-based structures to represent compiler/Cargo errors as "continuations" in the Layer 9 data fabric.

7.  **Implement SAT Solver Integration**:
    *   Design the interface for a SAT solver to consume these error continuations and generate/select appropriate semantic patches (`EditJobConfig` TOML files or `mkbuildrs!` arguments).

## 4. Architectural Notes

*   **Modular Design**: `mkslop-core` for logic, `mkslop-macros` for proc-macro interface.
*   **Declarative > Imperative**: Continue converting imperative `build.rs` logic into declarative `mkbuildrs!` invocations.
*   **Self-Referentiality**: Leverage the `Expr` meta-model for deep reflection and auto-generation/auto-correction.
